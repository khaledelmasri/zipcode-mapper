<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLS Ground Priority & Ground Alliance Territories</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: #666; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #map { width: 100%; height: calc(100vh - 200px); min-height: 600px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 13px; color: #666; margin-bottom: 8px; text-transform: uppercase; }
        .stat-card .number { font-size: 32px; font-weight: 700; color: #2196F3; }
        .legend { position: fixed; bottom: 20px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-width: 300px; }
        .legend h3 { margin-bottom: 15px; font-size: 16px; }
        .legend-item { display: flex; align-items: center; margin: 10px 0; }
        .legend-item .color-box { width: 30px; height: 30px; border-radius: 4px; margin-right: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .error { background: #ffebee; color: #c62828; padding: 20px; margin: 20px; border-radius: 8px; border-left: 4px solid #f44336; }
        .search-box { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; background: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); width: 400px; max-width: 90%; }
        .search-box input { width: 100%; padding: 12px 14px; border: 2px solid #2196F3; border-radius: 6px; font-size: 15px; outline: none; }
        .search-result { margin-top: 8px; font-size: 13px; color: #666; }
        .zip-info-banner { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: white; padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 1000; min-width: 250px; text-align: left; }
        .zip-info-banner .close-btn { position: absolute; top: 8px; right: 12px; cursor: pointer; font-size: 20px; color: #999; font-weight: bold; }
        .zip-info-banner .close-btn:hover { color: #333; }
        .zip-info-banner .zip-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .zip-info-banner .zip-value { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 12px; }
        .zip-info-banner .color-preview { width: 100%; height: 40px; border-radius: 4px; margin-top: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è GLS Ground Priority & Ground Alliance Territories</h1>
        <p>Real-time ZIP code territory map with actual ZCTA boundaries</p>
    </div>
    
    <div class="stats" id="stats" style="display: none;">
        <div class="stat-card"><h3>Total ZIP Codes</h3><div class="number" id="totalZips">0</div></div>
        <div class="stat-card"><h3>Territory A (Red)</h3><div class="number" id="territoryA">0</div></div>
        <div class="stat-card"><h3>Territory B (Yellow)</h3><div class="number" id="territoryB">0</div></div>
        <div class="stat-card"><h3>Load Time</h3><div class="number" id="loadTime">0s</div></div>
    </div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div id="loadingText">Loading territory data...</div>
    </div>
    
    <div style="position: relative; max-width: 100%;">
        <div class="search-box" id="searchBox" style="display: none;">
            <input type="text" id="zipSearchInput" placeholder="üîç Search ZIP Code (e.g., 90001)" />
            <div class="search-result" id="searchResult"></div>
        </div>
        <div id="zipInfoContainer"></div>
        <div id="map" style="display: none;"></div>
    </div>
    
    <div class="legend" id="legend" style="display: none;">
        <h3>üìç Territory Legend</h3>
        <div class="legend-item">
            <div class="color-box" style="background: #E74C3C;"></div>
            <div><strong>Territory A</strong><br><span style="font-size: 12px; color: #666;" id="countA">0 ZIPs</span></div>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #F39C12;"></div>
            <div><strong>Territory B</strong><br><span style="font-size: 12px; color: #666;" id="countB">0 ZIPs</span></div>
        </div>
    </div>

    <script>
        const startTime = Date.now();
        let map, zipPolygons = [];
        const stateCache = {};
        
        function showZipBanner(zipCode, territory, state, color) {
            // Remove any existing banner
            const container = document.getElementById('zipInfoContainer');
            container.innerHTML = '';
            
            // Create new banner
            const banner = document.createElement('div');
            banner.className = 'zip-info-banner';
            banner.innerHTML = `
                <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>
                <div class="zip-label">ZIP Code</div>
                <div class="zip-value">${zipCode}</div>
                <div class="zip-label">Territory</div>
                <div class="zip-value">${territory}</div>
                <div class="zip-label">State</div>
                <div class="zip-value">${state}</div>
                <div class="color-preview" style="background: ${color};"></div>
            `;
            
            container.appendChild(banner);
        }
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: { lat: 39.8283, lng: -98.5795 },
                mapTypeId: 'roadmap'
            });
            
            // Setup search box
            setupSearch();
            
            // Auto-load data
            loadTerritoryData();
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('zipSearchInput');
            
            searchInput.addEventListener('keyup', function(e) {
                const zip = this.value.trim();
                const resultDiv = document.getElementById('searchResult');
                
                if (zip.length === 5 && /^\d{5}$/.test(zip)) {
                    // Find this ZIP in our data
                    const zipDataGlobal = window.zipDataGlobal || [];
                    const found = zipDataGlobal.find(z => z.zip === zip);
                    
                    if (found) {
                        resultDiv.innerHTML = `<span style="color: #2e7d32;">‚úì ${found.territory} - ${found.color === '#E74C3C' ? 'Territory A' : 'Territory B'}</span>`;
                        
                        // Find and zoom to this ZIP if loaded
                        const state = getStateFromZip(zip);
                        if (state) {
                            resultDiv.innerHTML += ` (${state})`;
                        }
                    } else {
                        resultDiv.innerHTML = '<span style="color: #c62828;">‚úó ZIP not in territories</span>';
                    }
                } else if (zip.length > 0) {
                    resultDiv.innerHTML = '<span style="color: #666;">Enter 5-digit ZIP code</span>';
                } else {
                    resultDiv.innerHTML = '';
                }
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const zip = this.value.trim();
                    if (zip.length === 5) {
                        searchAndZoom(zip);
                    }
                }
            });
        }
        
        function searchAndZoom(zip) {
            // Use geocoding to find ZIP location
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: zip + ', USA' }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(12);
                    
                    // Add temporary marker
                    const marker = new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location,
                        animation: google.maps.Animation.DROP
                    });
                    
                    setTimeout(() => marker.setMap(null), 3000);
                }
            });
        }
        
        async function loadTerritoryData() {
            try {
                updateLoading('üì• Downloading territory data...');
                
                // Load CSV from GitHub
                const csvUrl = 'https://khaledelmasri.github.io/zipcode-mapper/gls-territories.csv';
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to load territory data');
                }
                
                const csvText = await response.text();
                const zipData = parseCSV(csvText);
                
                updateLoading(`üìä Processing ${zipData.length} ZIP codes...`);
                
                // Render the map
                await renderZipCodes(zipData);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Error Loading Data</strong><br><br>
                        ${error.message}<br><br>
                        Please make sure the CSV file is uploaded to GitHub.
                    </div>
                `;
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
                if (parts.length >= 3 && /^\d{5}$/.test(parts[0])) {
                    data.push({
                        zip: parts[0],
                        territory: parts[1],
                        color: parts[2].toLowerCase() === 'red' ? '#E74C3C' : '#F39C12'
                    });
                }
            }
            
            // Store globally for search
            window.zipDataGlobal = data;
            
            return data;
        }
        
        function updateLoading(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        async function renderZipCodes(zipData) {
            const zipsByState = {};
            for (const item of zipData) {
                const stateCode = getStateFromZip(item.zip);
                if (stateCode) {
                    if (!zipsByState[stateCode]) zipsByState[stateCode] = [];
                    zipsByState[stateCode].push(item);
                }
            }
            
            const stateCount = Object.keys(zipsByState).length;
            const stateCodes = Object.keys(zipsByState);
            let mapped = 0;
            let territoryACount = zipData.filter(z => z.territory === 'Territory A').length;
            let territoryBCount = zipData.filter(z => z.territory === 'Territory B').length;
            
            updateLoading(`üó∫Ô∏è Loading ${stateCount} states...`);
            
            // Load states sequentially
            for (let i = 0; i < stateCodes.length; i++) {
                const stateCode = stateCodes[i];
                
                try {
                    let geojson = stateCache[stateCode];
                    
                    if (!geojson) {
                        const stateName = getStateName(stateCode);
                        if (!stateName) continue;
                        
                        updateLoading(`Loading ${stateCode} (${i+1}/${stateCount})...`);
                        
                        const url = `https://khaledelmasri.github.io/zipcode-mapper/data/${stateCode.toLowerCase()}_${stateName}_zip_codes_geo.min.json`;
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            geojson = await response.json();
                            stateCache[stateCode] = geojson;
                        } else {
                            continue;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    if (geojson) {
                        updateLoading(`Rendering ${stateCode} ZIP codes...`);
                        
                        const zips = zipsByState[stateCode];
                        
                        for (const item of zips) {
                            const feature = geojson.features.find(f => 
                                f.properties.ZCTA5CE10 === item.zip || 
                                f.properties.GEOID10 === item.zip ||
                                f.properties.ZIP === item.zip
                            );
                            
                            if (feature) {
                                const polygon = new google.maps.Data();
                                polygon.addGeoJson({ type: 'FeatureCollection', features: [feature] });
                                polygon.setMap(map);
                                
                                const originalColor = item.color;
                                
                                polygon.setStyle({
                                    fillColor: originalColor,
                                    fillOpacity: 0.6,
                                    strokeColor: originalColor,
                                    strokeWeight: 2,
                                    strokeOpacity: 0.9
                                });
                                
                                polygon.addListener('click', (event) => {
                                    showZipBanner(item.zip, item.territory, stateCode, originalColor);
                                });
                                
                                polygon.addListener('mouseover', () => {
                                    polygon.setStyle({ fillColor: originalColor, fillOpacity: 0.85, strokeColor: originalColor, strokeWeight: 3, strokeOpacity: 1 });
                                });
                                
                                polygon.addListener('mouseout', () => {
                                    polygon.setStyle({ fillColor: originalColor, fillOpacity: 0.6, strokeColor: originalColor, strokeWeight: 2, strokeOpacity: 0.9 });
                                });
                                
                                zipPolygons.push(polygon);
                                mapped++;
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error(`Error loading ${stateCode}:`, error);
                }
            }
            
            finishRendering(mapped, zipData.length, territoryACount, territoryBCount);
        }
        
        function finishRendering(mapped, total, territoryA, territoryB) {
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            
            // Hide loading, show map
            document.getElementById('loading').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('searchBox').style.display = 'block';
            document.getElementById('legend').style.display = 'block';
            document.getElementById('stats').style.display = 'grid';
            
            // Update stats
            document.getElementById('totalZips').textContent = mapped;
            document.getElementById('territoryA').textContent = territoryA;
            document.getElementById('territoryB').textContent = territoryB;
            document.getElementById('loadTime').textContent = duration + 's';
            document.getElementById('countA').textContent = territoryA + ' ZIPs';
            document.getElementById('countB').textContent = territoryB + ' ZIPs';
            
            // Fit map to boundaries
            if (zipPolygons.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                let count = 0;
                zipPolygons.forEach(poly => {
                    poly.forEach(feature => {
                        feature.getGeometry().forEachLatLng(latlng => {
                            bounds.extend(latlng);
                            count++;
                            if (count > 1000) return;
                        });
                    });
                });
                map.fitBounds(bounds);
            }
        }
        
        function getStateFromZip(zip) {
            const prefix = parseInt(zip.substring(0, 3));
            if (prefix >= 350 && prefix <= 369) return 'AL';
            if (prefix >= 995 && prefix <= 999) return 'AK';
            if (prefix >= 850 && prefix <= 865) return 'AZ';
            if (prefix >= 716 && prefix <= 729) return 'AR';
            if (prefix >= 900 && prefix <= 961) return 'CA';
            if (prefix >= 800 && prefix <= 816) return 'CO';
            if (prefix >= 60 && prefix <= 69) return 'CT';
            if (prefix >= 197 && prefix <= 199) return 'DE';
            if (prefix >= 320 && prefix <= 349) return 'FL';
            if (prefix >= 300 && prefix <= 319) return 'GA';
            if (prefix >= 967 && prefix <= 968) return 'HI';
            if (prefix >= 832 && prefix <= 838) return 'ID';
            if (prefix >= 600 && prefix <= 629) return 'IL';
            if (prefix >= 460 && prefix <= 479) return 'IN';
            if (prefix >= 500 && prefix <= 528) return 'IA';
            if (prefix >= 660 && prefix <= 679) return 'KS';
            if (prefix >= 400 && prefix <= 427) return 'KY';
            if (prefix >= 700 && prefix <= 714) return 'LA';
            if (prefix >= 39 && prefix <= 49) return 'ME';
            if (prefix >= 206 && prefix <= 219) return 'MD';
            if (prefix >= 10 && prefix <= 27) return 'MA';
            if (prefix >= 480 && prefix <= 499) return 'MI';
            if (prefix >= 550 && prefix <= 567) return 'MN';
            if (prefix >= 386 && prefix <= 397) return 'MS';
            if (prefix >= 630 && prefix <= 658) return 'MO';
            if (prefix >= 590 && prefix <= 599) return 'MT';
            if (prefix >= 680 && prefix <= 693) return 'NE';
            if (prefix >= 889 && prefix <= 898) return 'NV';
            if (prefix >= 30 && prefix <= 38) return 'NH';
            if (prefix >= 70 && prefix <= 89) return 'NJ';
            if (prefix >= 870 && prefix <= 884) return 'NM';
            if (prefix >= 100 && prefix <= 149) return 'NY';
            if (prefix >= 270 && prefix <= 289) return 'NC';
            if (prefix >= 580 && prefix <= 588) return 'ND';
            if (prefix >= 430 && prefix <= 458) return 'OH';
            if (prefix >= 730 && prefix <= 749) return 'OK';
            if (prefix >= 970 && prefix <= 979) return 'OR';
            if (prefix >= 150 && prefix <= 196) return 'PA';
            if (prefix >= 28 && prefix <= 29) return 'RI';
            if (prefix >= 290 && prefix <= 299) return 'SC';
            if (prefix >= 570 && prefix <= 577) return 'SD';
            if (prefix >= 370 && prefix <= 385) return 'TN';
            if (prefix >= 750 && prefix <= 799) return 'TX';
            if (prefix >= 840 && prefix <= 847) return 'UT';
            if (prefix >= 50 && prefix <= 59) return 'VT';
            if (prefix >= 220 && prefix <= 246) return 'VA';
            if (prefix >= 980 && prefix <= 994) return 'WA';
            if (prefix >= 247 && prefix <= 268) return 'WV';
            if (prefix >= 530 && prefix <= 549) return 'WI';
            if (prefix >= 820 && prefix <= 831) return 'WY';
            return null;
        }
        
        function getStateName(code) {
            const names = {
                'AL': 'alabama', 'AK': 'alaska', 'AZ': 'arizona', 'AR': 'arkansas',
                'CA': 'california', 'CO': 'colorado', 'CT': 'connecticut', 'DE': 'delaware',
                'FL': 'florida', 'GA': 'georgia', 'HI': 'hawaii', 'ID': 'idaho',
                'IL': 'illinois', 'IN': 'indiana', 'IA': 'iowa', 'KS': 'kansas',
                'KY': 'kentucky', 'LA': 'louisiana', 'ME': 'maine', 'MD': 'maryland',
                'MA': 'massachusetts', 'MI': 'michigan', 'MN': 'minnesota', 'MS': 'mississippi',
                'MO': 'missouri', 'MT': 'montana', 'NE': 'nebraska', 'NV': 'nevada',
                'NH': 'new_hampshire', 'NJ': 'new_jersey', 'NM': 'new_mexico', 'NY': 'new_york',
                'NC': 'north_carolina', 'ND': 'north_dakota', 'OH': 'ohio', 'OK': 'oklahoma',
                'OR': 'oregon', 'PA': 'pennsylvania', 'RI': 'rhode_island', 'SC': 'south_carolina',
                'SD': 'south_dakota', 'TN': 'tennessee', 'TX': 'texas', 'UT': 'utah',
                'VT': 'vermont', 'VA': 'virginia', 'WA': 'washington', 'WV': 'west_virginia',
                'WI': 'wisconsin', 'WY': 'wyoming'
            };
            return names[code] || null;
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUGnWrE9ku1D9IL8OvK86VRfp_-zVWb60&callback=initMap" async defer></script>
</body>
</html>
